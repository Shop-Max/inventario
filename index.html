<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Contabilidad de Negocio</title>
  <script src="https://unpkg.com/localforage/dist/localforage.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    h1, h2, h3 {
      text-align: center;
    }
    form, #filterPanel, #adminPanel {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    tr.agotado {
      background: #f8d7da;
    }
    .agotado-btn {
      background: red;
      color: white;
      border: none;
      padding: 5px 10px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% {
        opacity: 0;
      }
    }
    #productForm input,
    #productForm button {
      flex: 1 1 30px;
      min-width: 100px;
    }
    img.product-img {
      width: 50px;
      height: auto;
    }
    @media (max-width: 600px) {
      table, th, td {
        font-size: 12px;
        padding: 6px;
      }
      form, #filterPanel, #adminPanel {
        flex-direction: column;
        align-items: stretch;
      }
      input, select, button {
        width: 100%;
        box-sizing: border-box;
      }
      .product-img {
        width: 100%;
        max-width: 150px;
      }
    }
  </style>
</head>
<body>
  <h1>üìä Contabilidad de Negocio</h1>

  <div id="loginPanel">
    <h2>Iniciar Sesi√≥n</h2>
    <input id="loginUser" placeholder="Usuario" />
    <input id="loginPass" type="password" placeholder="Contrase√±a" />
    <button id="loginBtn">Ingresar</button>
  </div>

  <div id="welcomeMessage"></div>

  <div id="filterPanel" style="display:none;">
    <h3>Filtrar Productos</h3>
    <select id="filterCategory"></select>
    <input id="filterName" placeholder="Buscar Producto" />
    <button id="applyFilter">üîç Filtrar</button>
  </div>

  <table id="productTable" style="display:none;">
    <thead>
      <tr>
        <th>ID</th><th>Producto</th><th>Categor√≠a</th><th>Cantidad</th>
        <th>Precio Unitario</th><th>Precio por Cantidad</th>
        <th>Comisi√≥n</th><th>Imagen</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="adminPanel" style="display:none; flex-direction: column; align-items: center;">
    <button id="downloadExcelBtn" style="margin: 20px; background: green;">üì• Descargar Excel</button>

    <h3 id="formTitle">Agregar Producto</h3>

    <form id="productForm">
      <input id="productId" type="hidden" />
      <input id="name" placeholder="Producto" required />
      <input id="category" placeholder="Categor√≠a" required />
      <input id="price" type="number" placeholder="Precio Unitario" step="0.01" required />
      <input id="bulkPrice" type="number" placeholder="Precio por Cantidad" step="0.01" required />
      <input id="commission" type="number" placeholder="Comisi√≥n" step="0.01" />
      <input id="quantity" type="number" placeholder="Cantidad" required />
      <input id="image" type="file" accept="image/*" />
      <button type="submit" id="saveBtn">üíæ Guardar</button>
      <button type="button" id="cancelEditBtn" style="display:none; background:#6c757d;">Cancelar</button>
    </form>

    <h3>Crear Usuario Nuevo</h3>
    <form id="createUserForm">
      <input id="newUser" placeholder="Nuevo Usuario" required />
      <input id="newPass" type="password" placeholder="Contrase√±a" required />
      <select id="newRole">
        <option value="admin">Admin</option>
        <option value="user">Usuario</option>
      </select>
      <button type="submit">Crear</button>
    </form>

    <h3>üìã Usuarios Registrados</h3>
    <table id="usersTable">
      <thead>
        <tr><th>Usuario</th><th>Contrase√±a</th><th>Rol</th><th>Acci√≥n</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
let products = [];
let users = [{ username: 'admin', password: 'admin', role: 'admin' }];
let currentUser = null;
let lastId = 0;

async function loadData() {
  const savedProducts = await localforage.getItem('products');
  if (savedProducts) products = savedProducts;
  const savedUsers = await localforage.getItem('users');
  if (savedUsers) users = savedUsers;
  const savedLastId = await localforage.getItem('lastId');
  if (savedLastId) lastId = savedLastId;
}

function saveProducts() {
  localforage.setItem('products', products);
  localforage.setItem('lastId', lastId);
}

function saveUsers() {
  localforage.setItem('users', users);
}

function descargarExcel() {
  if (!products || products.length === 0) {
    alert("No hay productos para exportar.");
    return;
  }

  const data = products.map(p => ({
    ID: p.id,
    Producto: p.name,
    Categor√≠a: p.category,
    Cantidad: p.quantity,
    'Precio Unitario': p.price,
    'Precio por Cantidad': p.bulkPrice,
    Comisi√≥n: p.commission || 0,
    'Imagen (Base64)': p.image || 'Sin imagen'
  }));

  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Productos");

  XLSX.writeFile(workbook, "productos.xlsx");
}

function renderUsers() {
  const usersTableBody = document.querySelector('#usersTable tbody');
  usersTableBody.innerHTML = '';
  users.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.username}</td><td>${u.password}</td><td>${u.role}</td><td>${u.username !== currentUser.username ? `<button class="delete-user-btn" data-user="${u.username}">üóëÔ∏è</button>` : ''}</td>`;
    usersTableBody.appendChild(tr);
  });
}

function renderProducts() {
  const tbody = document.querySelector('#productTable tbody');
  tbody.innerHTML = '';
  const fCat = document.getElementById('filterCategory').value.trim().toLowerCase();
  const fName = document.getElementById('filterName').value.trim().toLowerCase();
  products.forEach(p => {
    if (fCat && p.category.toLowerCase() !== fCat) return;
    if (fName && !p.name.toLowerCase().includes(fName)) return;
    const tr = document.createElement('tr');
    if (p.quantity <= 0) tr.classList.add('agotado');
    const comValue = p.commission || 0;
    const comCalc = (p.price * comValue / 100).toFixed(2);
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.category}</td>
      <td>${p.quantity > 0 ? p.quantity : '<button class="agotado-btn" disabled>Agotado</button>'}</td>
      <td>$${p.price.toFixed(2)}</td>
      <td>$${p.bulkPrice.toFixed(2)}</td>
      <td>${comValue}<br><small>($${comCalc})</small></td>
      <td>${p.image ? `<img class="product-img" src="${p.image}" /><br><a href="${p.image}" download="producto-${p.id}.png">üì•</a>` : 'Sin imagen'}</td>
      <td>${currentUser.role === 'admin' ? `<button class="edit-btn" data-id="${p.id}">‚úèÔ∏è</button><button class="delete-btn" data-id="${p.id}">üóëÔ∏è</button>` : ''}</td>
    `;
    tbody.appendChild(tr);
  });
}

function populateFilters() {
  const filterCategory = document.getElementById('filterCategory');
  const categories = [...new Set(products.map(p => p.category))];
  filterCategory.innerHTML = '<option value="">Todas las Categor√≠as</option>';
  categories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    filterCategory.appendChild(opt);
  });
}

document.getElementById('loginBtn').addEventListener('click', async () => {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  const found = users.find(user => user.username === u && user.password === p);
  if (found) {
    currentUser = found;

    // Carga los productos al iniciar sesi√≥n
    const savedProducts = await localforage.getItem('products');
    if (savedProducts) products = savedProducts;

    document.getElementById('loginPanel').style.display = 'none';
    document.getElementById('filterPanel').style.display = 'flex';
    document.getElementById('productTable').style.display = 'table';

    if (found.role === 'admin') {
      document.getElementById('adminPanel').style.display = 'flex';
      renderUsers();

      const btn = document.getElementById('downloadExcelBtn');
      if (btn) {
        btn.removeEventListener('click', descargarExcel);
        btn.addEventListener('click', descargarExcel);
      }
    }

    populateFilters();
    renderProducts();
    document.getElementById('welcomeMessage').textContent = `üëè Bienvenido, ${found.username}! üëè`;
  } else {
    alert('Usuario o contrase√±a incorrectos.');
  }
});

document.getElementById('applyFilter').addEventListener('click', () => renderProducts());

(async function init() {
  await loadData();
})();
</script>
</body>
</html>
